<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å­¦å…¨ç§‘å­¦ä¹ åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --poetry-color: #ff9a9e;
            --math-color: #a18cd1;
            --text-color: #333;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --success-color: #4caf50;
            --error-color: #f44336;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
        }
        .header-title { font-weight: bold; font-size: 1.1rem; }
        .back-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 5px;}

        main { flex: 1; position: relative; overflow: hidden; padding: 20px; }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px;
            display: flex; flex-direction: column; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease; transform: scale(0.98); overflow-y: auto;
        }
        .page.active { opacity: 1; pointer-events: all; transform: scale(1); z-index: 5; }

        /* é¦–é¡µæ¨¡å—æ ·å¼ */
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 500px; margin: 0 auto; width: 100%; }
        .module-card {
            background: var(--card-bg); border-radius: 20px; padding: 30px 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; border-left: 8px solid #ccc;
        }
        .module-card:active { transform: scale(0.98); }
        .card-poetry { border-color: var(--poetry-color); }
        .card-english { border-color: var(--primary-color); }
        .card-math { border-color: var(--math-color); }
        .module-icon { font-size: 3rem; margin-right: 20px; }
        .module-info h2 { font-size: 1.3rem; margin-bottom: 5px; }
        .module-info p { color: #888; font-size: 0.9rem; }

        /* åˆ—è¡¨æ ·å¼ */
        .list-item {
            background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); cursor: pointer;
        }
        .list-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .list-desc { color: #666; font-size: 0.9rem; }

        /* å¤è¯—è¯¦æƒ… */
        .poem-card {
            background: white; padding: 40px 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNmMGYwZjAiLz4KPC9zdmc+');
        }
        .poem-title { font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 10px; font-family: "Kaiti", "æ¥·ä½“", serif; }
        .poem-author { color: #666; font-size: 1rem; margin-bottom: 30px; }
        .poem-content { font-size: 1.4rem; line-height: 2; color: #444; font-family: "Kaiti", "æ¥·ä½“", serif; white-space: pre-wrap; }
        .mask-btn { margin-top: 30px; background: var(--poetry-color); color: white; border: none; padding: 10px 30px; border-radius: 30px; font-size: 1rem; }
        .masked .poem-content { color: transparent; text-shadow: 0 0 10px rgba(0,0,0,0.2); }

        /* æ•°å­¦åŠ¨ç”»åŒº */
        .math-stage {
            background: white; border-radius: 20px; height: 300px; margin-bottom: 20px;
            position: relative; display: flex; justify-content: center; align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05); overflow: hidden;
        }
        .math-controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .math-btn {
            padding: 10px 20px; background: var(--math-color); color: white; border: none;
            border-radius: 8px; font-size: 0.9rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .math-btn:active { transform: scale(0.95); }

        /* --- åŒ—å¸ˆå¤§ç‰ˆä¸‰å¹´çº§æ•°å­¦åŠ¨ç”»å…ƒç´  --- */

        /* 1. è§‚å¯Ÿç‰©ä½“ */
        .cube-container { position: relative; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; }
        .cube-block {
            width: 40px; height: 40px; background: var(--math-color); border: 2px solid #333;
            position: absolute; box-shadow: 5px 5px 0px rgba(0,0,0,0.2);
        }
        .cube-top { top: 0; left: 30px; }
        .cube-mid { top: 40px; left: 30px; }
        .cube-bot { top: 80px; left: 30px; }
        
        .view-projection {
            display: none; width: 100px; height: 100px; border: 2px dashed #666; display: flex; justify-content: center; align-items: center;
        }
        .view-active { display: flex; }
        .view-grid { display: grid; gap: 2px; grid-template-columns: repeat(3, 1fr); }
        .view-cell { width: 30px; height: 30px; border: 1px solid #ccc; }
        .view-cell.filled { background: var(--math-color); }

        /* 2. è½´å¯¹ç§° */
        .symmetry-container { position: relative; width: 200px; height: 200px; }
        .sym-half { position: absolute; top: 0; width: 50%; height: 100%; background: #eee; overflow: hidden; transition: transform 1s ease; transform-origin: right; backface-visibility: hidden; }
        .sym-left { left: 0; background: var(--math-color); display: flex; justify-content: center; align-items: center; font-size: 40px; }
        .sym-right { right: 0; background: var(--math-color); display: flex; justify-content: center; align-items: center; font-size: 40px; }
        .sym-folded .sym-right { transform: rotateY(180deg); background: rgba(161, 140, 209, 0.5); }

        /* 3. åˆ†æ•° */
        .fraction-circle {
            width: 160px; height: 160px; border-radius: 50%; background: #eee; position: relative; overflow: hidden;
        }
        .fraction-slice {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--math-color); clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 50% 100%);
            opacity: 0; transition: opacity 0.5s;
        }
        .slice-1 { transform: rotate(0deg); }
        .slice-2 { transform: rotate(90deg); clip-path: polygon(50% 50%, 50% 0%, 100% 0%); }
        .slice-3 { transform: rotate(180deg); clip-path: polygon(50% 50%, 50% 0%, 0% 0%); }
        .slice-4 { transform: rotate(270deg); clip-path: polygon(50% 50%, 50% 100%, 0% 100%); }

        /* 4. é¢ç§¯ä¸å‘¨é•¿ */
        .shape-box {
            width: 180px; height: 120px; position: relative; border: 10px solid #333; background: white;
            transition: all 0.5s;
        }
        .shape-area-mode { background-color: var(--math-color); border-color: #333; opacity: 0.8; }
        .shape-perimeter-mode { border-color: var(--success-color); border-width: 15px; background: white; }
        .shape-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: bold; font-size: 1.2rem; z-index: 2;
        }

        /* 5. è®¤è¯†å°æ•° */
        .decimal-display { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .coin { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #bfa560; background: radial-gradient(#ffd700, #daa520); display: flex; justify-content: center; align-items: center; font-weight: bold; color: #8b4500; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: all 0.3s; }
        .coin-jiao { width: 40px; height: 40px; background: radial-gradient(#c0c0c0, #a9a9a9); border-color: #696969; }
        .jiao-container { display: flex; gap: 5px; flex-wrap: wrap; width: 120px; justify-content: center; }
        .fade-in { opacity: 1; transform: scale(1); }
        .fade-out { opacity: 0; transform: scale(0.5); }

        /* è‹±è¯­æ ·å¼ */
        .user-stats { display: flex; gap: 15px; font-size: 0.9rem; font-weight: bold; }
        .stat-item { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; }
        
        .flashcard { background: var(--card-bg); width: 100%; max-width: 350px; height: 400px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; margin: 0 auto; perspective: 1000px; }
        .word-emoji { font-size: 5rem; margin-bottom: 20px; }
        .word-en { font-size: 2.5rem; font-weight: bold; color: var(--text-color); margin-bottom: 5px; }
        .word-phonetic { font-size: 1.1rem; color: #888; margin-bottom: 20px; background: #f0f0f0; padding: 2px 8px; border-radius: 4px; }
        .word-cn { font-size: 1.5rem; color: var(--primary-color); margin-top: 10px; opacity: 0; transition: opacity 0.3s; }
        .word-cn.visible { opacity: 1; }
        .speaker-btn { position: absolute; top: 20px; right: 20px; background: #f0f0f0; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary-color); }
        .controls { display: flex; gap: 20px; width: 100%; max-width: 350px; margin: 30px auto 0; }
        .control-btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-know { background-color: var(--success-color); color: white; }
        .btn-forget { background-color: #e0e0e0; color: #666; }

        .quiz-container { width: 100%; max-width: 400px; margin: 0 auto; }
        .question-box { background: var(--card-bg); padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .question-text { font-size: 1.8rem; font-weight: bold; color: var(--text-color); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { background: var(--card-bg); border: 2px solid transparent; padding: 20px; border-radius: 15px; font-size: 1.1rem; color: var(--text-color); cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: all 0.2s; text-align: center; }
        .option-btn.correct { background-color: #e8f5e9; border-color: var(--success-color); color: var(--success-color); }
        .option-btn.wrong { background-color: #ffebee; border-color: var(--error-color); color: var(--error-color); }
        
        .result-emoji { font-size: 5rem; margin-bottom: 20px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .score-display { font-size: 3rem; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; }
        .btn { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }

        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header id="main-header">
        <button class="back-btn" id="back-btn" onclick="app.goHome()" style="visibility: hidden;">â¬…</button>
        <div class="header-title" id="header-title">å…¨ç§‘å­¦ä¹ åŠ©æ‰‹</div>
        <div class="user-stats" id="home-stats">
            <div class="stat-item">ğŸ”¥ <span id="streak-count">0</span></div>
            <div class="stat-item">â­ <span id="total-points">0</span></div>
        </div>
    </header>

    <main>
        <!-- 1. é¦–é¡µ -->
        <div id="page-home" class="page active">
            <div class="dashboard-grid">
                <div class="module-card card-poetry" onclick="app.goToPoetryList()">
                    <div class="module-icon">ğŸ“–</div>
                    <div class="module-info">
                        <h2>å¿…èƒŒå¤è¯—</h2>
                        <p>ç²¾é€‰12é¦–ç»å…¸å”è¯—å®‹è¯</p>
                    </div>
                </div>
                <div class="module-card card-english" onclick="app.startLearning()">
                    <div class="module-icon">ğŸ”¤</div>
                    <div class="module-info">
                        <h2>å•è¯æ‰“å¡</h2>
                        <p>æ¯æ—¥10è¯ï¼Œæµ·é‡è¯åº“éšæœº</p>
                    </div>
                </div>
                <div class="module-card card-math" onclick="app.goToMathList()">
                    <div class="module-icon">ğŸ“</div>
                    <div class="module-info">
                        <h2>æ•°å­¦æ¦‚å¿µ</h2>
                        <p>åŒ—å¸ˆå¤§ç‰ˆä¸‰å¹´çº§åŠ¨ç”»æ¼”ç¤º</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å¤è¯—åˆ—è¡¨ -->
        <div id="page-poems-list" class="page">
            <h3 style="margin-bottom: 20px;">é€‰æ‹©ä¸€é¦–è¯—</h3>
            <div id="poems-list-container"></div>
        </div>

        <!-- 3. å¤è¯—è¯¦æƒ… -->
        <div id="page-poem-detail" class="page">
            <div class="poem-card" id="poem-display">
                <div class="poem-title" id="p-title"></div>
                <div class="poem-author" id="p-author"></div>
                <div class="poem-content" id="p-content"></div>
            </div>
            <div style="text-align: center;">
                <button class="mask-btn" onclick="app.togglePoemMask()">ğŸ‘€ èƒŒè¯µæ¨¡å¼ (å¼€/å…³)</button>
            </div>
        </div>

        <!-- 4. æ•°å­¦åˆ—è¡¨ -->
        <div id="page-math-list" class="page">
            <h3 style="margin-bottom: 20px;">é€‰æ‹©æ¦‚å¿µæ¼”ç¤º</h3>
            <div id="math-list-container"></div>
        </div>

        <!-- 5. æ•°å­¦æ¼”ç¤º -->
        <div id="page-math-demo" class="page">
            <h3 id="math-demo-title" style="text-align:center; margin-bottom:10px;"></h3>
            <div class="math-stage" id="math-stage-box"></div>
            <div class="math-controls" id="math-controls-box"></div>
        </div>

        <!-- 6. è‹±è¯­å­¦ä¹  -->
        <div id="page-learn" class="page">
            <div class="flashcard">
                <button class="speaker-btn" onclick="app.speakCurrentWord()">ğŸ”Š</button>
                <div class="word-emoji" id="learn-emoji"></div>
                <div class="word-en" id="learn-word"></div>
                <div class="word-phonetic" id="learn-phonetic"></div>
                <div class="word-cn" id="learn-cn"></div>
            </div>
            <div class="controls">
                <button class="control-btn btn-forget" onclick="app.nextWord(false)">ä¸è®¤è¯†</button>
                <button class="control-btn btn-know" onclick="app.nextWord(true)">è®¤è¯†</button>
            </div>
            <div style="margin-top: 15px; color: #999; font-size: 0.9rem; text-align:center;">
                è¿›åº¦: <span id="learn-progress">1/10</span>
            </div>
        </div>

        <!-- 7. è‹±è¯­æµ‹è¯• -->
        <div id="page-quiz" class="page">
            <div class="quiz-container">
                <div class="question-box">
                    <p style="color:#888; margin-bottom: 10px;">è¯·é€‰æ‹©æ­£ç¡®çš„å•è¯</p>
                    <div class="question-text" id="quiz-question"></div>
                </div>
                <div class="options-grid" id="quiz-options"></div>
            </div>
        </div>

        <!-- 8. ç»“æœ -->
        <div id="page-result" class="page">
            <div class="home-card" style="text-align:center;">
                <div class="result-emoji" id="result-emoji"></div>
                <div class="score-display" id="final-score"></div>
                <p style="font-weight: bold; margin-bottom: 20px;">ä»Šæ—¥æ‰“å¡æˆåŠŸï¼</p>
                <div class="result-detail">
                    <p>è¿ç»­åšæŒ: <span id="result-streak"></span> å¤©</p>
                    <p>è·å¾—ç§¯åˆ†: <span id="result-points"></span></p>
                </div>
                <button class="btn" onclick="app.goHome()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        // --- 1. æ•°æ®å®šä¹‰ ---
        const POEMS = [
            { id: 1, title: 'é™å¤œæ€', author: '[å”] æç™½', content: 'åºŠå‰æ˜æœˆå…‰ï¼Œ\nç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œ\nä½å¤´æ€æ•…ä¹¡ã€‚' },
            { id: 2, title: 'æœ›åºå±±ç€‘å¸ƒ', author: '[å”] æç™½', content: 'æ—¥ç…§é¦™ç‚‰ç”Ÿç´«çƒŸï¼Œ\né¥çœ‹ç€‘å¸ƒæŒ‚å‰å·ã€‚\né£æµç›´ä¸‹ä¸‰åƒå°ºï¼Œ\nç–‘æ˜¯é“¶æ²³è½ä¹å¤©ã€‚' },
            { id: 3, title: 'èµ æ±ªä¼¦', author: '[å”] æç™½', content: 'æç™½ä¹˜èˆŸå°†æ¬²è¡Œï¼Œ\nå¿½é—»å²¸ä¸Šè¸æ­Œå£°ã€‚\næ¡ƒèŠ±æ½­æ°´æ·±åƒå°ºï¼Œ\nä¸åŠæ±ªä¼¦é€æˆ‘æƒ…ã€‚' },
            { id: 4, title: 'ç»å¥', author: '[å”] æœç”«', content: 'ä¸¤ä¸ªé»„é¹‚é¸£ç¿ æŸ³ï¼Œ\nä¸€è¡Œç™½é¹­ä¸Šé’å¤©ã€‚\nçª—å«è¥¿å²­åƒç§‹é›ªï¼Œ\né—¨æ³Šä¸œå´ä¸‡é‡Œèˆ¹ã€‚' },
            { id: 5, title: 'æ˜¥æ™“', author: '[å”] å­Ÿæµ©ç„¶', content: 'æ˜¥çœ ä¸è§‰æ™“ï¼Œ\nå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼Œ\nèŠ±è½çŸ¥å¤šå°‘ã€‚' },
            { id: 6, title: 'æ‚¯å†œ', author: '[å”] æç»…', content: 'é”„ç¦¾æ—¥å½“åˆï¼Œ\næ±—æ»´ç¦¾ä¸‹åœŸã€‚\nè°çŸ¥ç›˜ä¸­é¤ï¼Œ\nç²’ç²’çš†è¾›è‹¦ã€‚' },
            { id: 7, title: 'å’é¹…', author: '[å”] éª†å®¾ç‹', content: 'é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œ\næ›²é¡¹å‘å¤©æ­Œã€‚\nç™½æ¯›æµ®ç»¿æ°´ï¼Œ\nçº¢æŒæ‹¨æ¸…æ³¢ã€‚' },
            { id: 8, title: 'ç™»é¹³é›€æ¥¼', author: '[å”] ç‹ä¹‹æ¶£', content: 'ç™½æ—¥ä¾å±±å°½ï¼Œ\né»„æ²³å…¥æµ·æµã€‚\næ¬²ç©·åƒé‡Œç›®ï¼Œ\næ›´ä¸Šä¸€å±‚æ¥¼ã€‚' },
            { id: 9, title: 'æ±Ÿé›ª', author: '[å”] æŸ³å®—å…ƒ', content: 'åƒå±±é¸Ÿé£ç»ï¼Œ\nä¸‡å¾„äººè¸ªç­ã€‚\nå­¤èˆŸè“‘ç¬ ç¿ï¼Œ\nç‹¬é’“å¯’æ±Ÿé›ªã€‚' },
            { id: 10, title: 'æ¸¸å­åŸ', author: '[å”] å­ŸéƒŠ', content: 'æ…ˆæ¯æ‰‹ä¸­çº¿ï¼Œ\næ¸¸å­èº«ä¸Šè¡£ã€‚\nä¸´è¡Œå¯†å¯†ç¼ï¼Œ\næ„æè¿Ÿè¿Ÿå½’ã€‚' },
            { id: 11, title: 'å¯»éšè€…ä¸é‡', author: '[å”] è´¾å²›', content: 'æ¾ä¸‹é—®ç«¥å­ï¼Œ\nè¨€å¸ˆé‡‡è¯å»ã€‚\nåªåœ¨æ­¤å±±ä¸­ï¼Œ\näº‘æ·±ä¸çŸ¥å¤„ã€‚' },
            { id: 12, title: 'é£', author: '[å”] æä¾¨', content: 'è§£è½ä¸‰ç§‹å¶ï¼Œ\nèƒ½å¼€äºŒæœˆèŠ±ã€‚\nè¿‡æ±Ÿåƒå°ºæµªï¼Œ\nå…¥ç«¹ä¸‡ç«¿æ–œã€‚' }
        ];

        // åŒ—å¸ˆå¤§ç‰ˆä¸‰å¹´çº§æ•°å­¦æ•°æ®
        const MATH_DEMOS = [
            {
                id: 'observe', title: 'è§‚å¯Ÿç‰©ä½“', desc: 'ä»ä¸åŒä½ç½®è§‚å¯Ÿç‰©ä½“ï¼Œçœ‹åˆ°çš„å½¢çŠ¶å¯èƒ½ä¸åŒã€‚',
                init: (stage) => {
                    stage.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <div class="cube-container" id="cube-3d">
                                <div class="cube-block cube-top"></div>
                                <div class="cube-block cube-mid"></div>
                                <div class="cube-block cube-bot"></div>
                            </div>
                            <div style="font-size:12px; margin-top:10px; color:#666;">(ç«‹ä½“å›¾)</div>
                            <div class="view-projection view-active" id="view-result" style="margin-top:20px;">
                                <div class="view-grid">
                                    <div class="view-cell"></div><div class="view-cell filled"></div><div class="view-cell"></div>
                                    <div class="view-cell"></div><div class="view-cell filled"></div><div class="view-cell"></div>
                                    <div class="view-cell"></div><div class="view-cell filled"></div><div class="view-cell"></div>
                                </div>
                            </div>
                        </div>`;
                },
                action: (view) => {
                    const result = document.getElementById('view-result');
                    result.innerHTML = '';
                    let grid = document.createElement('div');
                    grid.className = 'view-grid';
                    let pattern = [];
                    if(view === 'front') { pattern = [0,1,0, 0,1,0, 0,1,0]; } 
                    else if (view === 'top') { pattern = [0,0,0, 0,1,0, 0,0,0]; }
                    else if (view === 'left') { pattern = [0,0,0, 0,1,0, 0,0,0]; }

                    pattern.forEach(filled => {
                        let cell = document.createElement('div');
                        cell.className = 'view-cell ' + (filled ? 'filled' : '');
                        grid.appendChild(cell);
                    });
                    result.appendChild(grid);
                }
            },
            {
                id: 'symmetry', title: 'è½´å¯¹ç§°å›¾å½¢', desc: 'å¦‚æœä¸€ä¸ªå›¾å½¢æ²¿ç€ä¸€æ¡ç›´çº¿å¯¹æŠ˜ï¼Œä¸¤éƒ¨åˆ†å®Œå…¨é‡åˆï¼Œå°±æ˜¯è½´å¯¹ç§°å›¾å½¢ã€‚',
                init: (stage) => {
                    stage.innerHTML = `
                        <div class="symmetry-container" id="sym-shape">
                            <div class="sym-half sym-left">ğŸ¦‹</div>
                            <div class="sym-half sym-right">ğŸ¦‹</div>
                        </div>
                        <div style="margin-top:10px; font-size:12px; color:#666;">(å¯¹æŠ˜æ¼”ç¤º)</div>
                    `;
                },
                action: () => { document.getElementById('sym-shape').classList.toggle('sym-folded'); }
            },
            {
                id: 'fraction', title: 'åˆ†æ•°çš„åˆæ­¥è®¤è¯†', desc: 'æŠŠä¸€ä¸ªæ•´ä½“å¹³å‡åˆ†æˆè‹¥å¹²ä»½ï¼Œå…¶ä¸­çš„ä¸€ä»½å°±æ˜¯è¿™ä¸ªæ•´ä½“çš„å‡ åˆ†ä¹‹ä¸€ã€‚',
                init: (stage) => {
                    stage.innerHTML = `
                        <div class="fraction-circle" id="frac-circle">
                            <div class="fraction-slice slice-1"></div>
                            <div class="fraction-slice slice-2"></div>
                            <div class="fraction-slice slice-3"></div>
                            <div class="fraction-slice slice-4"></div>
                        </div>
                        <div style="position:absolute; bottom:10px; font-size:24px; font-weight:bold;" id="frac-text">0/4</div>
                    `;
                },
                action: (num) => {
                    document.querySelectorAll('.fraction-slice').forEach(el => el.style.opacity = '0');
                    const text = document.getElementById('frac-text');
                    for(let i=1; i<=num; i++) {
                        document.querySelector(`.slice-${i}`).style.opacity = '1';
                    }
                    text.innerText = `${num}/4`;
                }
            },
            {
                id: 'area_perimeter', title: 'é¢ç§¯ä¸å‘¨é•¿', desc: 'å‘¨é•¿æ˜¯å›´æˆå›¾å½¢ä¸€å‘¨è¾¹çº¿çš„é•¿åº¦ï¼›é¢ç§¯æ˜¯ç‰©ä½“è¡¨é¢æˆ–å°é—­å›¾å½¢çš„å¤§å°ã€‚',
                init: (stage) => {
                    stage.innerHTML = `
                        <div style="text-align:center;">
                            <div class="shape-box" id="rect-shape">
                                <div class="shape-label">å›¾å½¢</div>
                            </div>
                            <div style="margin-top:20px; font-size:14px; line-height:1.5;" id="calc-result">
                                å‘¨é•¿ï¼š?(cm)<br>é¢ç§¯ï¼š?(cmÂ²)
                            </div>
                        </div>
                    `;
                },
                action: (type) => {
                    const shape = document.getElementById('rect-shape');
                    const text = document.getElementById('calc-result');
                    if(type === 'perimeter') {
                        shape.className = 'shape-box shape-perimeter-mode';
                        text.innerHTML = `<span style="color:var(--success-color)">å‘¨é•¿ï¼š60cm (å›´æˆä¸€åœˆ)</span><br>é¢ç§¯ï¼š216cmÂ²`;
                    } else {
                        shape.className = 'shape-box shape-area-mode';
                        text.innerHTML = `å‘¨é•¿ï¼š60cm<br><span style="color:var(--math-color)">é¢ç§¯ï¼š216cmÂ² (æ¶‚æ»¡é¢œè‰²)</span>`;
                    }
                }
            },
            {
                id: 'decimal', title: 'è®¤è¯†å°æ•°', desc: 'åƒ3.45, 0.85è¿™æ ·çš„æ•°å«åšå°æ•°ã€‚å°æ•°ç‚¹å·¦è¾¹æ˜¯æ•´æ•°éƒ¨åˆ†ï¼Œå³è¾¹æ˜¯å°æ•°éƒ¨åˆ†ã€‚',
                init: (stage) => {
                    stage.innerHTML = `
                        <div class="decimal-display">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="coin">1</div>
                                <span style="font-size:20px;">+</span>
                                <div style="display:flex; gap:2px;" id="jiao-box"></div>
                            </div>
                            <div style="font-size:24px; font-weight:bold; margin-top:10px;">= <span id="decimal-val">1.0</span> å…ƒ</div>
                        </div>
                    `;
                },
                action: (val) => {
                    const jiaoBox = document.getElementById('jiao-box');
                    const decimalVal = document.getElementById('decimal-val');
                    jiaoBox.innerHTML = '';
                    let count = 0;
                    if(val === 'half') count = 5;
                    if(val === 'nine') count = 9;

                    for(let i=0; i<count; i++) {
                        setTimeout(() => {
                            let c = document.createElement('div');
                            c.className = 'coin coin-jiao fade-in';
                            c.innerHTML = 'è§’';
                            jiaoBox.appendChild(c);
                        }, i * 100);
                    }
                    decimalVal.innerText = `1.${count}`;
                }
            }
        ];

        // å•è¯åº“ (50+)
        const VOCABULARY = [
            { en: 'Apple', phonetic: '/ËˆÃ¦p.l/', cn: 'è‹¹æœ', emoji: 'ğŸ' }, { en: 'Banana', phonetic: '/bÉ™ËˆnÃ¦n.É™/', cn: 'é¦™è•‰', emoji: 'ğŸŒ' },
            { en: 'Bread', phonetic: '/bred/', cn: 'é¢åŒ…', emoji: 'ğŸ' }, { en: 'Rice', phonetic: '/raÉªs/', cn: 'ç±³é¥­', emoji: 'ğŸš' },
            { en: 'Egg', phonetic: '/eÉ¡/', cn: 'é¸¡è›‹', emoji: 'ğŸ¥š' }, { en: 'Milk', phonetic: '/mÉªlk/', cn: 'ç‰›å¥¶', emoji: 'ğŸ¥›' },
            { en: 'Water', phonetic: '/ËˆwÉ”Ë.tÉ™r/', cn: 'æ°´', emoji: 'ğŸ’§' }, { en: 'Cake', phonetic: '/keÉªk/', cn: 'è›‹ç³•', emoji: 'ğŸ°' },
            { en: 'Cat', phonetic: '/kÃ¦t/', cn: 'çŒ«', emoji: 'ğŸ±' }, { en: 'Dog', phonetic: '/dÉ’É¡/', cn: 'ç‹—', emoji: 'ğŸ¶' },
            { en: 'Bird', phonetic: '/bÉœËrd/', cn: 'é¸Ÿ', emoji: 'ğŸ¦' }, { en: 'Panda', phonetic: '/ËˆpÃ¦n.dÉ™/', cn: 'ç†ŠçŒ«', emoji: 'ğŸ¼' },
            { en: 'Tiger', phonetic: '/ËˆtaÉª.É¡É™r/', cn: 'è€è™', emoji: 'ğŸ¯' }, { en: 'Monkey', phonetic: '/ËˆmÊŒÅ‹.ki/', cn: 'çŒ´å­', emoji: 'ğŸµ' },
            { en: 'Red', phonetic: '/red/', cn: 'çº¢è‰²', emoji: 'ğŸ”´' }, { en: 'Blue', phonetic: '/bluË/', cn: 'è“è‰²', emoji: 'ğŸ”µ' },
            { en: 'Green', phonetic: '/É¡riËn/', cn: 'ç»¿è‰²', emoji: 'ğŸŸ¢' }, { en: 'Yellow', phonetic: '/Ëˆjel.É™ÊŠ/', cn: 'é»„è‰²', emoji: 'ğŸŸ¡' },
            { en: 'Black', phonetic: '/blÃ¦k/', cn: 'é»‘è‰²', emoji: 'âš«' }, { en: 'White', phonetic: '/waÉªt/', cn: 'ç™½è‰²', emoji: 'âšª' },
            { en: 'Head', phonetic: '/hed/', cn: 'å¤´', emoji: 'ğŸ—£ï¸' }, { en: 'Hand', phonetic: '/hÃ¦nd/', cn: 'æ‰‹', emoji: 'âœ‹' },
            { en: 'Foot', phonetic: '/fÊŠt/', cn: 'è„š', emoji: 'ğŸ¦¶' }, { en: 'Eye', phonetic: '/aÉª/', cn: 'çœ¼ç›', emoji: 'ğŸ‘ï¸' },
            { en: 'School', phonetic: '/skuËl/', cn: 'å­¦æ ¡', emoji: 'ğŸ«' }, { en: 'Book', phonetic: '/bÊŠk/', cn: 'ä¹¦', emoji: 'ğŸ“–' },
            { en: 'Pen', phonetic: '/pen/', cn: 'é’¢ç¬”', emoji: 'ğŸ–Šï¸' }, { en: 'Bag', phonetic: '/bÃ¦É¡/', cn: 'ä¹¦åŒ…', emoji: 'ğŸ’' },
            { en: 'Desk', phonetic: '/desk/', cn: 'ä¹¦æ¡Œ', emoji: 'ğŸª‘' }, { en: 'Ruler', phonetic: '/ËˆruË.lÉ™r/', cn: 'å°ºå­', emoji: 'ğŸ“' },
            { en: 'One', phonetic: '/wÊŒn/', cn: 'ä¸€', emoji: '1ï¸âƒ£' }, { en: 'Two', phonetic: '/tuË/', cn: 'äºŒ', emoji: '2ï¸âƒ£' },
            { en: 'Three', phonetic: '/Î¸riË/', cn: 'ä¸‰', emoji: '3ï¸âƒ£' }, { en: 'Ten', phonetic: '/ten/', cn: 'å', emoji: 'ğŸ”Ÿ' },
            { en: 'Family', phonetic: '/ËˆfÃ¦m.É™l.i/', cn: 'å®¶åº­', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' }, { en: 'Friend', phonetic: '/frend/', cn: 'æœ‹å‹', emoji: 'ğŸ¤' },
            { en: 'Happy', phonetic: '/ËˆhÃ¦p.i/', cn: 'å¿«ä¹', emoji: 'ğŸ˜Š' }, { en: 'Sad', phonetic: '/sÃ¦d/', cn: 'ä¼¤å¿ƒ', emoji: 'ğŸ˜¢' },
            { en: 'Run', phonetic: '/rÊŒn/', cn: 'è·‘', emoji: 'ğŸƒ' }, { en: 'Jump', phonetic: '/dÊ’ÊŒmp/', cn: 'è·³', emoji: 'ğŸ¦˜' },
            { en: 'Big', phonetic: '/bÉªÉ¡/', cn: 'å¤§', emoji: 'ğŸ˜' }, { en: 'Small', phonetic: '/smÉ”Ël/', cn: 'å°', emoji: 'ğŸœ' }
        ];

        // --- åº”ç”¨é€»è¾‘ ---
        const app = {
            state: {
                streak: 0, points: 0, lastLoginDate: null,
                voices: [], isAudioUnlocked: false,
                learnQueue: [], currentLearnIndex: 0,
                quizQueue: [], currentQuizIndex: 0, quizScore: 0
            },

            init: function() {
                this.loadVoices();
                if (window.speechSynthesis && window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = this.loadVoices.bind(this);
                }
                this.loadData();
                this.updateHeader();
            },

            loadVoices: function() { 
                try {
                    this.state.voices = window.speechSynthesis.getVoices();
                } catch(e) { console.warn("Load voices error", e); }
            },
            
            // ä¿®å¤ï¼šå¢åŠ äº†å®‰å…¨æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨ä¸æ”¯æŒè¯­éŸ³çš„æ‰‹æœºä¸Šç‚¹å‡»æ— ååº”
            unlockAudio: function() {
                if (this.state.isAudioUnlocked) return;
                if (window.speechSynthesis && window.speechSynthesis.speak) {
                    try {
                        const u = new SpeechSynthesisUtterance('');
                        u.text = '';
                        window.speechSynthesis.speak(u);
                    } catch (e) {
                        console.warn("Audio unlock failed", e);
                    }
                }
                this.state.isAudioUnlocked = true;
            },

            speakText: function(text) {
                if (!window.speechSynthesis) return;
                try {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US';
                    if (this.state.voices.length > 0) {
                        const enVoice = this.state.voices.find(v => (v.lang.includes('en-US') || v.lang.includes('en_US')) && (v.name.includes('Google') || v.name.includes('Samantha')));
                        if (enVoice) utterance.voice = enVoice;
                    }
                    window.speechSynthesis.speak(utterance);
                } catch(e) { console.warn("Speak error", e); }
            },

            showPage: function(pageId, title = 'å…¨ç§‘å­¦ä¹ åŠ©æ‰‹', showBack = true) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                const headerTitle = document.getElementById('header-title');
                const backBtn = document.getElementById('back-btn');
                const stats = document.getElementById('home-stats');
                headerTitle.innerText = title;
                backBtn.style.visibility = showBack ? 'visible' : 'hidden';
                stats.style.visibility = showBack ? 'hidden' : 'visible';
                if(pageId === 'page-home') document.getElementById('math-stage-box').innerHTML = '';
            },

            goHome: function() { this.showPage('page-home'); },

            // --- å¤è¯— ---
            goToPoetryList: function() {
                const container = document.getElementById('poems-list-container');
                container.innerHTML = POEMS.map(p => `
                    <div class="list-item" onclick="app.showPoemDetail(${p.id})">
                        <div class="list-title">${p.title}</div>
                        <div class="list-desc">${p.author}</div>
                    </div>
                `).join('');
                this.showPage('page-poems-list', 'å¿…èƒŒå¤è¯—');
            },
            showPoemDetail: function(id) {
                const poem = POEMS.find(p => p.id === id);
                document.getElementById('p-title').innerText = poem.title;
                document.getElementById('p-author').innerText = poem.author;
                document.getElementById('p-content').innerText = poem.content;
                document.querySelector('.poem-card').classList.remove('masked');
                this.showPage('page-poem-detail', poem.title);
            },
            togglePoemMask: function() { document.querySelector('.poem-card').classList.toggle('masked'); },

            // --- æ•°å­¦ ---
            goToMathList: function() {
                const container = document.getElementById('math-list-container');
                container.innerHTML = MATH_DEMOS.map(m => `
                    <div class="list-item" onclick="app.showMathDemo('${m.id}')">
                        <div class="list-title">${m.title}</div>
                        <div class="list-desc">${m.desc}</div>
                    </div>
                `).join('');
                this.showPage('page-math-list', 'æ•°å­¦æ¦‚å¿µ');
            },
            showMathDemo: function(id) {
                const demo = MATH_DEMOS.find(m => m.id === id);
                this.showPage('page-math-demo', demo.title);
                const stage = document.getElementById('math-stage-box');
                const controls = document.getElementById('math-controls-box');
                stage.innerHTML = ''; controls.innerHTML = '';
                demo.init(stage);

                if (id === 'observe') {
                    ['æ­£é¢', 'ä¸Šé¢', 'å·¦é¢'].forEach((view, idx) => {
                        const btn = document.createElement('button');
                        btn.className = 'math-btn';
                        btn.innerText = view + 'çœ‹';
                        btn.onclick = () => demo.action(['front','top','left'][idx]);
                        controls.appendChild(btn);
                    });
                } else if (id === 'fraction') {
                    ['1/4', '2/4', '3/4', '4/4'].forEach((frac, idx) => {
                        const btn = document.createElement('button');
                        btn.className = 'math-btn';
                        btn.innerText = frac;
                        btn.onclick = () => demo.action(idx+1);
                        controls.appendChild(btn);
                    });
                } else if (id === 'area_perimeter') {
                    ['çœ‹å‘¨é•¿', 'çœ‹é¢ç§¯'].forEach((type) => {
                        const btn = document.createElement('button');
                        btn.className = 'math-btn';
                        btn.innerText = type;
                        btn.onclick = () => demo.action(type.includes('å‘¨é•¿') ? 'perimeter' : 'area');
                        controls.appendChild(btn);
                    });
                } else if (id === 'decimal') {
                    ['0.5å…ƒ', '0.9å…ƒ'].forEach((val) => {
                        const btn = document.createElement('button');
                        btn.className = 'math-btn';
                        btn.innerText = val;
                        btn.onclick = () => demo.action(val.includes('0.5') ? 'half' : 'nine');
                        controls.appendChild(btn);
                    });
                } else {
                    const btn = document.createElement('button');
                    btn.className = 'math-btn';
                    btn.innerText = 'å¯¹æŠ˜åŠ¨ç”»';
                    btn.onclick = demo.action;
                    controls.appendChild(btn);
                }
            },

            // --- è‹±è¯­ ---
            startLearning: function() {
                this.unlockAudio();
                const shuffled = [...VOCABULARY].sort(() => 0.5 - Math.random());
                this.state.learnQueue = shuffled.slice(0, 10);
                this.state.currentLearnIndex = 0;
                this.renderLearnCard();
                this.showPage('page-learn', 'å•è¯å­¦ä¹ ');
            },

            renderLearnCard: function() {
                const word = this.state.learnQueue[this.state.currentLearnIndex];
                document.getElementById('learn-emoji').innerText = word.emoji;
                document.getElementById('learn-word').innerText = word.en;
                document.getElementById('learn-phonetic').innerText = word.phonetic;
                document.getElementById('learn-cn').innerText = word.cn;
                document.getElementById('learn-cn').classList.remove('visible');
                document.getElementById('learn-progress').innerText = `${this.state.currentLearnIndex + 1}/10`;
            },

            speakCurrentWord: function() { this.speakText(this.state.learnQueue[this.state.currentLearnIndex].en); },

            nextWord: function(known) {
                const cnDiv = document.getElementById('learn-cn');
                if (!cnDiv.classList.contains('visible')) {
                    cnDiv.classList.add('visible');
                    this.speakCurrentWord();
                    return;
                }
                this.state.currentLearnIndex++;
                if (this.state.currentLearnIndex < this.state.learnQueue.length) {
                    this.renderLearnCard();
                } else {
                    this.startQuiz();
                }
            },

            startQuiz: function() {
                this.state.quizQueue = [...this.state.learnQueue];
                this.state.currentQuizIndex = 0;
                this.state.quizScore = 0;
                this.renderQuizQuestion();
                this.showPage('page-quiz', 'å•è¯æµ‹è¯•');
            },

            renderQuizQuestion: function() {
                const questionWord = this.state.quizQueue[this.state.currentQuizIndex];
                document.getElementById('quiz-question').innerText = `${questionWord.emoji} ${questionWord.cn}`;
                let options = [questionWord];
                const otherWords = VOCABULARY.filter(w => w.en !== questionWord.en);
                const distractors = otherWords.sort(() => 0.5 - Math.random()).slice(0, 3);
                options = options.concat(distractors).sort(() => 0.5 - Math.random());
                const container = document.getElementById('quiz-options');
                container.innerHTML = options.map(opt => `
                    <div class="option-btn" onclick="app.handleQuizAnswer(this, '${opt.en}' === '${questionWord.en}', '${questionWord.en}')">${opt.en}</div>
                `).join('');
            },

            handleQuizAnswer: function(btn, isCorrect, correctWordEn) {
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.style.pointerEvents = 'none');
                if (isCorrect) {
                    btn.classList.add('correct');
                    this.state.quizScore++;
                    this.speakText("Great!");
                } else {
                    btn.classList.add('wrong');
                    this.speakText("Try again");
                    allBtns.forEach(b => { if (b.innerText === correctWordEn) b.classList.add('correct'); });
                }
                setTimeout(() => {
                    this.state.currentQuizIndex++;
                    if (this.state.currentQuizIndex < this.state.quizQueue.length) this.renderQuizQuestion();
                    else this.finishDailyTask();
                }, 1200);
            },

            finishDailyTask: function() {
                const today = new Date().toDateString();
                const isNewDay = this.state.lastLoginDate !== today;
                if (isNewDay) {
                    this.state.streak++;
                    this.state.points += (10 + this.state.quizScore * 2); 
                    this.state.lastLoginDate = today;
                    this.saveData();
                }
                document.getElementById('result-emoji').innerText = this.state.quizScore === 10 ? 'ğŸ†' : 'ğŸ‰';
                document.getElementById('final-score').innerText = `${this.state.quizScore * 10}åˆ†`;
                document.getElementById('result-streak').innerText = this.state.streak;
                this.showPage('page-result', 'æ‰“å¡æˆåŠŸ', false);
                this.updateHeader();
            },

            loadData: function() {
                try {
                    const data = localStorage.getItem('vocabApp_data');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.state.streak = parsed.streak || 0;
                        this.state.points = parsed.points || 0;
                        this.state.lastLoginDate = parsed.lastLoginDate;
                    }
                } catch(e) { console.warn("Load data error", e); }
            },
            saveData: function() {
                try {
                    localStorage.setItem('vocabApp_data', JSON.stringify({
                        streak: this.state.streak, points: this.state.points, lastLoginDate: this.state.lastLoginDate
                    }));
                } catch(e) { console.warn("Save data error", e); }
            },
            updateHeader: function() {
                document.getElementById('streak-count').innerText = this.state.streak;
                document.getElementById('total-points').innerText = this.state.points;
            }
        };

        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>