<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å¹´çº§å…¨ç§‘æ‰“å¡</title>
    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --poetry-color: #ff9a9e;
            --math-color: #a18cd1;
            --text-color: #333;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --success-color: #4caf50;
            --error-color: #f44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é€šç”¨å¤´éƒ¨ */
        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            padding: 15px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .header-title { font-weight: bold; font-size: 1.1rem; }
        .back-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 5px;}

        /* ä¸»å†…å®¹åŒºåŸŸ */
        main {
            flex: 1;
            position: relative;
            overflow: hidden;
            padding: 20px;
        }

        /* é¡µé¢åˆ‡æ¢é€»è¾‘ */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: scale(0.98);
            overflow-y: auto; /* å…è®¸é¡µé¢å†…éƒ¨æ»šåŠ¨ */
        }

        .page.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 5;
        }

        /* --- é¦–é¡µæ¨¡å—æ ·å¼ --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .module-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.1s;
            border-left: 8px solid #ccc;
        }

        .module-card:active { transform: scale(0.98); }

        .card-poetry { border-color: var(--poetry-color); }
        .card-english { border-color: var(--primary-color); }
        .card-math { border-color: var(--math-color); }

        .module-icon { font-size: 3rem; margin-right: 20px; }
        .module-info h2 { font-size: 1.3rem; margin-bottom: 5px; }
        .module-info p { color: #888; font-size: 0.9rem; }

        /* --- åˆ—è¡¨é¡µæ ·å¼ (å¤è¯—/æ•°å­¦åˆ—è¡¨) --- */
        .list-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            cursor: pointer;
        }
        .list-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .list-desc { color: #666; font-size: 0.9rem; }

        /* --- å¤è¯—è¯¦æƒ…é¡µ --- */
        .poem-card {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNmMGYwZjAiLz4KPC9zdmc+');
        }
        .poem-title { font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 10px; font-family: "Kaiti", "æ¥·ä½“", serif; }
        .poem-author { color: #666; font-size: 1rem; margin-bottom: 30px; }
        .poem-content { font-size: 1.4rem; line-height: 2; color: #444; font-family: "Kaiti", "æ¥·ä½“", serif; white-space: pre-wrap; }
        
        .mask-btn {
            margin-top: 30px;
            background: var(--poetry-color);
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 1rem;
        }
        .masked .poem-content { color: transparent; text-shadow: 0 0 10px rgba(0,0,0,0.2); }

        /* --- æ•°å­¦åŠ¨ç”»æ¼”ç¤ºåŒº --- */
        .math-stage {
            background: white;
            border-radius: 20px;
            height: 300px;
            margin-bottom: 20px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .math-controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .math-btn {
            padding: 10px 20px;
            background: var(--math-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* æ•°å­¦åŠ¨ç”»ç‰¹å®šå…ƒç´  */
        /* åˆ†æ•°ï¼šæŠ«è¨ */
        .pizza { width: 150px; height: 150px; border-radius: 50%; background: #ddd; transition: all 1s; position: relative; }
        .pizza-slice { 
            position: absolute; width: 100%; height: 100%; border-radius: 50%; 
            background: var(--math-color); clip-path: polygon(50% 50%, 50% 0%, 100% 0%); 
            transform-origin: 50% 50%; transition: transform 0.5s;
        }
        /* é¢ç§¯ï¼šç½‘æ ¼ */
        .area-box { width: 200px; height: 120px; border: 2px solid #333; display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(6, 1fr); }
        .area-tile { background-color: #eee; transition: background-color 0.3s; }
        .area-tile.filled { background-color: var(--math-color); }
        /* å‘¨é•¿ï¼šè·‘æ­¥å°äºº */
        .perimeter-track { width: 200px; height: 120px; border: 4px dashed #ccc; position: relative; }
        .runner { width: 20px; height: 20px; background: red; border-radius: 50%; position: absolute; top: -12px; left: -12px; transition: all 2s linear; }

        /* --- è‹±è¯­åŸæœ‰æ ·å¼ (ä¿ç•™) --- */
        .user-stats { display: flex; gap: 15px; font-size: 0.9rem; font-weight: bold; }
        .stat-item { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; }
        
        .flashcard { background: var(--card-bg); width: 100%; max-width: 350px; height: 400px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; margin: 0 auto; perspective: 1000px; }
        .word-emoji { font-size: 5rem; margin-bottom: 20px; }
        .word-en { font-size: 2.5rem; font-weight: bold; color: var(--text-color); margin-bottom: 5px; }
        .word-phonetic { font-size: 1.1rem; color: #888; margin-bottom: 20px; background: #f0f0f0; padding: 2px 8px; border-radius: 4px; }
        .word-cn { font-size: 1.5rem; color: var(--primary-color); margin-top: 10px; opacity: 0; transition: opacity 0.3s; }
        .word-cn.visible { opacity: 1; }
        .speaker-btn { position: absolute; top: 20px; right: 20px; background: #f0f0f0; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary-color); }
        .controls { display: flex; gap: 20px; width: 100%; max-width: 350px; margin: 30px auto 0; }
        .control-btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-know { background-color: var(--success-color); color: white; }
        .btn-forget { background-color: #e0e0e0; color: #666; }

        .quiz-container { width: 100%; max-width: 400px; margin: 0 auto; }
        .question-box { background: var(--card-bg); padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .question-text { font-size: 1.8rem; font-weight: bold; color: var(--text-color); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { background: var(--card-bg); border: 2px solid transparent; padding: 20px; border-radius: 15px; font-size: 1.1rem; color: var(--text-color); cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: all 0.2s; text-align: center; }
        .option-btn.correct { background-color: #e8f5e9; border-color: var(--success-color); color: var(--success-color); }
        .option-btn.wrong { background-color: #ffebee; border-color: var(--error-color); color: var(--error-color); }
        
        .result-emoji { font-size: 5rem; margin-bottom: 20px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .score-display { font-size: 3rem; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; }
        .btn { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }

        /* Toast */
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <!-- å¤´éƒ¨ (åŠ¨æ€å˜åŒ–) -->
    <header id="main-header">
        <button class="back-btn" id="back-btn" onclick="app.goHome()" style="visibility: hidden;">â¬…</button>
        <div class="header-title" id="header-title">å…¨ç§‘å­¦ä¹ åŠ©æ‰‹</div>
        <div class="user-stats" id="home-stats">
            <div class="stat-item">ğŸ”¥ <span id="streak-count">0</span></div>
            <div class="stat-item">â­ <span id="total-points">0</span></div>
        </div>
    </header>

    <main>
        <!-- 1. é¦–é¡µ Dashboard -->
        <div id="page-home" class="page active">
            <div class="dashboard-grid">
                <!-- æ¨¡å—ä¸€ï¼šå¤è¯— -->
                <div class="module-card card-poetry" onclick="app.goToPoetryList()">
                    <div class="module-icon">ğŸ“–</div>
                    <div class="module-info">
                        <h2>å¿…èƒŒå¤è¯—</h2>
                        <p>ä¸‰å¹´çº§ç»å…¸è¯—è¯ï¼Œæ”¯æŒèƒŒè¯µæ¨¡å¼</p>
                    </div>
                </div>
                <!-- æ¨¡å—äºŒï¼šè‹±è¯­ -->
                <div class="module-card card-english" onclick="app.startLearning()">
                    <div class="module-icon">ğŸ”¤</div>
                    <div class="module-info">
                        <h2>å•è¯æ‰“å¡</h2>
                        <p>æ¯æ—¥5è¯ï¼Œå‘éŸ³+æµ‹è¯•</p>
                    </div>
                </div>
                <!-- æ¨¡å—ä¸‰ï¼šæ•°å­¦ -->
                <div class="module-card card-math" onclick="app.goToMathList()">
                    <div class="module-icon">ğŸ“</div>
                    <div class="module-info">
                        <h2>æ•°å­¦æ¦‚å¿µ</h2>
                        <p>åŠ¨ç”»æ¼”ç¤ºï¼šåˆ†æ•°ã€é¢ç§¯ã€å‘¨é•¿</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å¤è¯—åˆ—è¡¨é¡µ -->
        <div id="page-poems-list" class="page">
            <h3 style="margin-bottom: 20px;">é€‰æ‹©ä¸€é¦–è¯—</h3>
            <div id="poems-list-container">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 3. å¤è¯—è¯¦æƒ…é¡µ -->
        <div id="page-poem-detail" class="page">
            <div class="poem-card" id="poem-display">
                <div class="poem-title" id="p-title">ç»å¥</div>
                <div class="poem-author" id="p-author">[å”] æœç”«</div>
                <div class="poem-content" id="p-content">ä¸¤ä¸ªé»„é¹‚é¸£ç¿ æŸ³...</div>
            </div>
            <div style="text-align: center;">
                <button class="mask-btn" onclick="app.togglePoemMask()">ğŸ‘€ èƒŒè¯µæ¨¡å¼ (å¼€/å…³)</button>
            </div>
        </div>

        <!-- 4. æ•°å­¦åˆ—è¡¨é¡µ -->
        <div id="page-math-list" class="page">
            <h3 style="margin-bottom: 20px;">é€‰æ‹©æ¦‚å¿µæ¼”ç¤º</h3>
            <div id="math-list-container">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 5. æ•°å­¦åŠ¨ç”»é¡µ -->
        <div id="page-math-demo" class="page">
            <h3 id="math-demo-title" style="text-align:center; margin-bottom:10px;">åˆ†æ•°çš„è®¤è¯†</h3>
            <div class="math-stage" id="math-stage-box">
                <!-- åŠ¨æ€æ³¨å…¥åŠ¨ç”»å…ƒç´  -->
            </div>
            <div class="math-controls" id="math-controls-box">
                <!-- åŠ¨æ€æ³¨å…¥æ§åˆ¶æŒ‰é’® -->
            </div>
        </div>

        <!-- 6. è‹±è¯­å­¦ä¹ é¡µ -->
        <div id="page-learn" class="page">
            <div class="flashcard">
                <button class="speaker-btn" onclick="app.speakCurrentWord()">ğŸ”Š</button>
                <div class="word-emoji" id="learn-emoji">ğŸ</div>
                <div class="word-en" id="learn-word">Apple</div>
                <div class="word-phonetic" id="learn-phonetic">/ËˆÃ¦p.l/</div>
                <div class="word-cn" id="learn-cn">è‹¹æœ</div>
            </div>
            <div class="controls">
                <button class="control-btn btn-forget" onclick="app.nextWord(false)">ä¸è®¤è¯†</button>
                <button class="control-btn btn-know" onclick="app.nextWord(true)">è®¤è¯†</button>
            </div>
            <div style="margin-top: 15px; color: #999; font-size: 0.9rem; text-align:center;">
                è¿›åº¦: <span id="learn-progress">1/5</span>
            </div>
        </div>

        <!-- 7. è‹±è¯­æµ‹è¯•é¡µ -->
        <div id="page-quiz" class="page">
            <div class="quiz-container">
                <div class="question-box">
                    <p style="color:#888; margin-bottom: 10px;">è¯·é€‰æ‹©æ­£ç¡®çš„å•è¯</p>
                    <div class="question-text" id="quiz-question">è‹¹æœ</div>
                </div>
                <div class="options-grid" id="quiz-options"></div>
            </div>
        </div>

        <!-- 8. ç»“æœé¡µ -->
        <div id="page-result" class="page">
            <div class="home-card" style="text-align:center;">
                <div class="result-emoji" id="result-emoji">ğŸ‰</div>
                <div class="score-display" id="final-score">100</div>
                <p style="font-weight: bold; margin-bottom: 20px;">ä»Šæ—¥æ‰“å¡æˆåŠŸï¼</p>
                <div class="result-detail">
                    <p>è¿ç»­åšæŒ: <span id="result-streak">1</span> å¤©</p>
                    <p>è·å¾—ç§¯åˆ†: <span id="result-points">+10</span></p>
                </div>
                <button class="btn" onclick="app.goHome()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </main>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <script>
        // --- æ•°æ®å®šä¹‰ ---

        const POEMS = [
            { id: 1, title: 'ç»å¥', author: '[å”] æœç”«', content: 'ä¸¤ä¸ªé»„é¹‚é¸£ç¿ æŸ³ï¼Œ\nä¸€è¡Œç™½é¹­ä¸Šé’å¤©ã€‚\nçª—å«è¥¿å²­åƒç§‹é›ªï¼Œ\né—¨æ³Šä¸œå´ä¸‡é‡Œèˆ¹ã€‚' },
            { id: 2, title: 'æƒ å´‡æ˜¥æ±Ÿæ™šæ™¯', author: '[å®‹] è‹è½¼', content: 'ç«¹å¤–æ¡ƒèŠ±ä¸‰ä¸¤æï¼Œ\næ˜¥æ±Ÿæ°´æš–é¸­å…ˆçŸ¥ã€‚\nè’Œè’¿æ»¡åœ°èŠ¦èŠ½çŸ­ï¼Œ\næ­£æ˜¯æ²³è±šæ¬²ä¸Šæ—¶ã€‚' },
            { id: 3, title: 'ä¸‰è¡¢é“ä¸­', author: '[å®‹] æ›¾å‡ ', content: 'æ¢…å­é»„æ—¶æ—¥æ—¥æ™´ï¼Œ\nå°æºªæ³›å°½å´å±±è¡Œã€‚\nç»¿é˜´ä¸å‡æ¥æ—¶è·¯ï¼Œ\næ·»å¾—é»„é¹‚å››äº”å£°ã€‚' },
            { id: 4, title: 'å¿†æ±Ÿå—', author: '[å”] ç™½å±…æ˜“', content: 'æ±Ÿå—å¥½ï¼Œ\né£æ™¯æ—§æ›¾è°™ã€‚\næ—¥å‡ºæ±ŸèŠ±çº¢èƒœç«ï¼Œ\næ˜¥æ¥æ±Ÿæ°´ç»¿å¦‚è“ã€‚\nèƒ½ä¸å¿†æ±Ÿå—ï¼Ÿ' }
        ];

        const MATH_DEMOS = [
            {
                id: 'fraction',
                title: 'åˆ†æ•°çš„è®¤è¯† (1/2)',
                desc: 'æŠŠä¸€ä¸ªåœ†å¹³å‡åˆ†æˆä¸¤ä»½ï¼Œæ¯ä»½æ˜¯å®ƒçš„äºŒåˆ†ä¹‹ä¸€ã€‚',
                init: (stage) => {
                    stage.innerHTML = `<div class="pizza"><div class="pizza-slice"></div></div>`;
                },
                action: () => {
                    const slice = document.querySelector('.pizza-slice');
                    slice.style.transform = 'rotate(0deg)';
                },
                action2: () => {
                    const slice = document.querySelector('.pizza-slice');
                    slice.style.transform = 'rotate(180deg)'; // è½¬åŠåœˆ
                }
            },
            {
                id: 'area',
                title: 'é¢ç§¯çš„æ¦‚å¿µ',
                desc: 'ç‰©ä½“çš„è¡¨é¢æˆ–å°é—­å›¾å½¢çš„å¤§å°ï¼Œå°±æ˜¯å®ƒä»¬çš„é¢ç§¯ã€‚',
                init: (stage) => {
                    let html = '<div class="area-box">';
                    for(let i=0; i<60; i++) html += `<div class="area-tile"></div>`;
                    html += '</div>';
                    stage.innerHTML = html;
                },
                action: () => {
                    document.querySelectorAll('.area-tile').forEach((t, i) => {
                        setTimeout(() => t.classList.add('filled'), i * 10);
                    });
                },
                reset: () => {
                    document.querySelectorAll('.area-tile').forEach(t => t.classList.remove('filled'));
                }
            },
            {
                id: 'perimeter',
                title: 'å‘¨é•¿çš„è®¤è¯†',
                desc: 'å°é—­å›¾å½¢ä¸€å‘¨çš„é•¿åº¦ï¼Œæ˜¯å®ƒçš„å‘¨é•¿ã€‚',
                init: (stage) => {
                    stage.innerHTML = `<div class="perimeter-track"><div class="runner"></div></div>`;
                },
                action: () => {
                    const runner = document.querySelector('.runner');
                    // é‡ç½®
                    runner.style.transition = 'none';
                    runner.style.transform = 'translate(0, 0)';
                    // å¼ºåˆ¶é‡ç»˜
                    runner.offsetHeight; 
                    // åŠ¨ç”»è·‘ä¸€åœˆ
                    runner.style.transition = 'top 0.5s linear, left 0.5s linear';
                    runner.style.left = '200px'; // å³
                    setTimeout(() => runner.style.top = '120px', 500); // ä¸‹
                    setTimeout(() => runner.style.left = '-12px', 1000); // å·¦
                    setTimeout(() => runner.style.top = '-12px', 1500); // ä¸Š
                }
            }
        ];

        const VOCABULARY = [
            { en: 'Apple', phonetic: '/ËˆÃ¦p.l/', cn: 'è‹¹æœ', emoji: 'ğŸ' },
            { en: 'Banana', phonetic: '/bÉ™ËˆnÃ¦n.É™/', cn: 'é¦™è•‰', emoji: 'ğŸŒ' },
            { en: 'Orange', phonetic: '/ËˆÉ”Ër.ÉªndÊ’/', cn: 'æ©™å­', emoji: 'ğŸŠ' },
            { en: 'Cat', phonetic: '/kÃ¦t/', cn: 'çŒ«', emoji: 'ğŸ±' },
            { en: 'Dog', phonetic: '/dÉ’É¡/', cn: 'ç‹—', emoji: 'ğŸ¶' },
            { en: 'Elephant', phonetic: '/Ëˆel.Éª.fÉ™nt/', cn: 'å¤§è±¡', emoji: 'ğŸ˜' },
            { en: 'Fish', phonetic: '/fÉªÊƒ/', cn: 'é±¼', emoji: 'ğŸŸ' },
            { en: 'Green', phonetic: '/É¡riËn/', cn: 'ç»¿è‰²', emoji: 'ğŸŸ¢' },
            { en: 'Red', phonetic: '/red/', cn: 'çº¢è‰²', emoji: 'ğŸ”´' },
            { en: 'Blue', phonetic: '/bluË/', cn: 'è“è‰²', emoji: 'ğŸ”µ' },
            { en: 'School', phonetic: '/skuËl/', cn: 'å­¦æ ¡', emoji: 'ğŸ«' },
            { en: 'Book', phonetic: '/bÊŠk/', cn: 'ä¹¦', emoji: 'ğŸ“–' },
            { en: 'Pencil', phonetic: '/Ëˆpen.sÉ™l/', cn: 'é“…ç¬”', emoji: 'âœï¸' },
            { en: 'Teacher', phonetic: '/ËˆtiË.tÊƒÉ™r/', cn: 'è€å¸ˆ', emoji: 'ğŸ‘©â€ğŸ«' },
            { en: 'Friend', phonetic: '/frend/', cn: 'æœ‹å‹', emoji: 'ğŸ¤' }
        ];

        // --- åº”ç”¨é€»è¾‘ ---

        const app = {
            state: {
                streak: 0, points: 0, lastLoginDate: null,
                voices: [], isAudioUnlocked: false,
                learnQueue: [], currentLearnIndex: 0,
                quizQueue: [], currentQuizIndex: 0, quizScore: 0
            },

            init: function() {
                this.loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = this.loadVoices.bind(this);
                }
                this.loadData();
                this.updateHeader();
            },

            loadVoices: function() { this.state.voices = window.speechSynthesis.getVoices(); },
            
            unlockAudio: function() {
                if (this.state.isAudioUnlocked) return;
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));
                this.state.isAudioUnlocked = true;
            },

            speakText: function(text) {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                const enVoice = this.state.voices.find(v => (v.lang.includes('en-US') || v.lang.includes('en_US')) && (v.name.includes('Google') || v.name.includes('Samantha')));
                if (enVoice) utterance.voice = enVoice;
                window.speechSynthesis.speak(utterance);
            },

            // --- å¯¼èˆª ---
            showPage: function(pageId, title = 'å…¨ç§‘å­¦ä¹ åŠ©æ‰‹', showBack = true) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                const headerTitle = document.getElementById('header-title');
                const backBtn = document.getElementById('back-btn');
                const stats = document.getElementById('home-stats');
                
                headerTitle.innerText = title;
                backBtn.style.visibility = showBack ? 'visible' : 'hidden';
                stats.style.visibility = showBack ? 'hidden' : 'visible';
                
                // å¦‚æœç¦»å¼€é¦–é¡µï¼Œæ¸…ç†ä»»ä½•åŠ¨ç”»
                if(pageId === 'page-home') {
                    document.getElementById('math-stage-box').innerHTML = '';
                }
            },

            goHome: function() { this.showPage('page-home'); },

            // --- å¤è¯—æ¨¡å— ---
            goToPoetryList: function() {
                const container = document.getElementById('poems-list-container');
                container.innerHTML = POEMS.map(p => `
                    <div class="list-item" onclick="app.showPoemDetail(${p.id})">
                        <div class="list-title">${p.title}</div>
                        <div class="list-desc">${p.author}</div>
                    </div>
                `).join('');
                this.showPage('page-poems-list', 'å¿…èƒŒå¤è¯—');
            },

            showPoemDetail: function(id) {
                const poem = POEMS.find(p => p.id === id);
                document.getElementById('p-title').innerText = poem.title;
                document.getElementById('p-author').innerText = poem.author;
                document.getElementById('p-content').innerText = poem.content;
                document.querySelector('.poem-card').classList.remove('masked');
                this.showPage('page-poem-detail', poem.title);
            },

            togglePoemMask: function() {
                document.querySelector('.poem-card').classList.toggle('masked');
            },

            // --- æ•°å­¦æ¨¡å— ---
            goToMathList: function() {
                const container = document.getElementById('math-list-container');
                container.innerHTML = MATH_DEMOS.map(m => `
                    <div class="list-item" onclick="app.showMathDemo('${m.id}')">
                        <div class="list-title">${m.title}</div>
                        <div class="list-desc">${m.desc}</div>
                    </div>
                `).join('');
                this.showPage('page-math-list', 'æ•°å­¦æ¦‚å¿µ');
            },

            showMathDemo: function(id) {
                const demo = MATH_DEMOS.find(m => m.id === id);
                this.showPage('page-math-demo', demo.title);
                
                const stage = document.getElementById('math-stage-box');
                const controls = document.getElementById('math-controls-box');
                
                stage.innerHTML = '';
                controls.innerHTML = '';

                demo.init(stage);

                // ç”Ÿæˆæ§åˆ¶æŒ‰é’®
                const btn1 = document.createElement('button');
                btn1.className = 'math-btn';
                btn1.innerText = id === 'fraction' ? 'è½¬åŠåœˆ (1/2)' : (id === 'area' ? 'é“ºæ»¡é¢ç§¯' : 'è·‘ä¸€åœˆ');
                btn1.onclick = demo.action;
                controls.appendChild(btn1);

                if(id === 'fraction') {
                    const btn0 = document.createElement('button');
                    btn0.className = 'math-btn';
                    btn0.innerText = 'é‡ç½®';
                    btn0.onclick = () => document.querySelector('.pizza-slice').style.transform = 'rotate(0deg)';
                    controls.appendChild(btn0);
                }
                if(id === 'area') {
                    const btnReset = document.createElement('button');
                    btnReset.className = 'math-btn';
                    btnReset.innerText = 'é‡ç½®';
                    btnReset.onclick = demo.reset;
                    controls.appendChild(btnReset);
                }
            },

            // --- è‹±è¯­æ¨¡å— (å¤ç”¨ä¹‹å‰çš„é€»è¾‘) ---
            startLearning: function() {
                this.unlockAudio();
                const shuffled = [...VOCABULARY].sort(() => 0.5 - Math.random());
                this.state.learnQueue = shuffled.slice(0, 5);
                this.state.currentLearnIndex = 0;
                this.renderLearnCard();
                this.showPage('page-learn', 'å•è¯å­¦ä¹ ');
            },

            renderLearnCard: function() {
                const word = this.state.learnQueue[this.state.currentLearnIndex];
                document.getElementById('learn-emoji').innerText = word.emoji;
                document.getElementById('learn-word').innerText = word.en;
                document.getElementById('learn-phonetic').innerText = word.phonetic;
                document.getElementById('learn-cn').innerText = word.cn;
                document.getElementById('learn-cn').classList.remove('visible');
                document.getElementById('learn-progress').innerText = `${this.state.currentLearnIndex + 1}/5`;
            },

            speakCurrentWord: function() {
                this.speakText(this.state.learnQueue[this.state.currentLearnIndex].en);
            },

            nextWord: function(known) {
                const cnDiv = document.getElementById('learn-cn');
                if (!cnDiv.classList.contains('visible')) {
                    cnDiv.classList.add('visible');
                    this.speakCurrentWord();
                    return;
                }
                this.state.currentLearnIndex++;
                if (this.state.currentLearnIndex < this.state.learnQueue.length) {
                    this.renderLearnCard();
                } else {
                    this.startQuiz();
                }
            },

            startQuiz: function() {
                this.state.quizQueue = [...this.state.learnQueue];
                this.state.currentQuizIndex = 0;
                this.state.quizScore = 0;
                this.renderQuizQuestion();
                this.showPage('page-quiz', 'å•è¯æµ‹è¯•');
            },

            renderQuizQuestion: function() {
                const questionWord = this.state.quizQueue[this.state.currentQuizIndex];
                document.getElementById('quiz-question').innerText = `${questionWord.emoji} ${questionWord.cn}`;
                let options = [questionWord];
                const otherWords = VOCABULARY.filter(w => w.en !== questionWord.en);
                const distractors = otherWords.sort(() => 0.5 - Math.random()).slice(0, 3);
                options = options.concat(distractors).sort(() => 0.5 - Math.random());

                const container = document.getElementById('quiz-options');
                container.innerHTML = options.map(opt => `
                    <div class="option-btn" onclick="app.handleQuizAnswer(this, '${opt.en}' === '${questionWord.en}', '${questionWord.en}')">${opt.en}</div>
                `).join('');
            },

            handleQuizAnswer: function(btn, isCorrect, correctWordEn) {
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.style.pointerEvents = 'none');
                if (isCorrect) {
                    btn.classList.add('correct');
                    this.state.quizScore++;
                    this.speakText("Great!");
                } else {
                    btn.classList.add('wrong');
                    this.speakText("Try again");
                    allBtns.forEach(b => { if (b.innerText === correctWordEn) b.classList.add('correct'); });
                }
                setTimeout(() => {
                    this.state.currentQuizIndex++;
                    if (this.state.currentQuizIndex < this.state.quizQueue.length) this.renderQuizQuestion();
                    else this.finishDailyTask();
                }, 1200);
            },

            finishDailyTask: function() {
                const today = new Date().toDateString();
                const isNewDay = this.state.lastLoginDate !== today;
                if (isNewDay) {
                    this.state.streak++;
                    this.state.points += (10 + this.state.quizScore * 2);
                    this.state.lastLoginDate = today;
                    this.saveData();
                }
                document.getElementById('result-emoji').innerText = this.state.quizScore === 5 ? 'ğŸ†' : 'ğŸ‰';
                document.getElementById('final-score').innerText = `${this.state.quizScore * 20}åˆ†`;
                document.getElementById('result-streak').innerText = this.state.streak;
                this.showPage('page-result', 'æ‰“å¡æˆåŠŸ', false);
                this.updateHeader();
            },

            loadData: function() {
                const data = localStorage.getItem('vocabApp_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.state.streak = parsed.streak || 0;
                    this.state.points = parsed.points || 0;
                    this.state.lastLoginDate = parsed.lastLoginDate;
                }
            },
            saveData: function() {
                localStorage.setItem('vocabApp_data', JSON.stringify({
                    streak: this.state.streak,
                    points: this.state.points,
                    lastLoginDate: this.state.lastLoginDate
                }));
            },
            updateHeader: function() {
                document.getElementById('streak-count').innerText = this.state.streak;
                document.getElementById('total-points').innerText = this.state.points;
            }
        };

        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>